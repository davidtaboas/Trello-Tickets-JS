(function(){
  'use strict';



  function config($locationProvider, $routeProvider) {
    $locationProvider.html5Mode(true);

    $routeProvider
      .when('/', {
        templateUrl: 'views/trello-login.tpl.html',
        controller: 'TrelloLoginCtrl',
        controllerAs: 'trellologin'
      })
      .when('/new', {
        templateUrl: 'views/trello-new-card.tpl.html',
        controller: 'NewCardCtrl',
        controllerAs: 'newcard'
      });
  }

  angular
    .module('trellojs', ['ngRoute', 'trellojs.controllers', 'trellojs.templates'])
    .config(config);

})();

(function(){
  'use strict';

  angular.module('trellojs.controllers', ['trellojs.services']);

  function TrelloLoginCtrl (Board,$scope){
    var self = this;

    self.loadProccess = function(){
      $scope.authenticated = true;
      $scope.token = Trello.token();

      Trello.get('/member/me/boards', {filter: 'open'})
        .success(function(response){
          $scope.$apply(function(){
            $scope.boards = response;
            $scope.boardsLoaded = true;
            $scope.selectedBoard = $scope.boards[0];
            $scope.selectBoard();
            setTimeout(function(){
                $('.selectpicker').selectpicker('refresh');
            }, 500);

          });
        })
        .error(function(){
          console.log('Ha ocurrido un error en la carga');
        });
    };

    if(Trello.authorized()){
      self.loadProccess();
    }
    // $scope.authenticated = Trello.authorized();
    $scope.boards        = [];
    $scope.selectedBoard = {};
    $scope.boardsLoaded  = false;

    $scope.allLists = {};
    self.topic = {};
    self.backlog = {};

    $scope.authenticate = function() {
      $scope.waitingForResolution = false;
      Trello.authorize({
        type: 'popup',
        name: 'Trello Trickets',
        scope: {read: true, write: true, account: true},
        expiration: 'never',
        success: $scope.authenticationSuccess,
        error: $scope.authenticationError
      });
	    $scope.waitingForResolution = true;

    };


    $scope.authenticationSuccess = function() {
      if($scope.waitingForResolution) {
        $scope.$apply(self.loadProccess);
      } else {
        self.loadProccess();
      }
    };

    $scope.authenticationError = function(error) {
      $scope.authenticationErrorMessage = error;
    };

    var getListTopics = function(element){
      return element.name === 'Projects';
    };
    var getListBacklog = function(element){
      return element.name === 'Backlog';
    };

    $scope.selectBoard = function(){
        // Obtener id lista de topics/sitios
        Trello.get('/boards/'+$scope.selectedBoard.id+'/lists')
          .success(function(response){
            $scope.$apply(function(){

              $scope.allLists = response;
              if (response.filter(getListTopics)) {
                self.topic = response.filter(getListTopics)[0];
              }
              if (response.filter(getListBacklog)) {
                self.backlog = response.filter(getListBacklog)[0];
              }

            });

          })
          .error(function(){
            console.log('Error obteniendo listas');
          });

        // Obtener usuarios del tablero
        Trello.get('/boards/'+$scope.selectedBoard.id+'/members')
          .success(function (response) {
            self.members = response;
          })
          .error(function () {

          });


    };


    $scope.save = function () {
      Board.saveMembers(self.members);
      Board.saveBacklog(self.backlog);
      Board.saveTopic(self.topic);
      Board.saveBoard(self.board);

    };


  }


  function NewCardCtrl(Board, $scope, $location) {
    var self = this;

    if(Trello.authorized()){
        $scope.authenticated = true;
    }
    else {
        $location.path('/');
    }
    self.topics = {};
    self.topic = Board.getTopic();
    self.members = Board.getMembers();
    self.board = Board.getBoard();
    self.backlog = Board.getBacklog();

    self.isSending = false;

    Trello.get('/lists/' + self.topic.id + '/cards')
      .success(function (response) {
        $scope.$apply(function () {
          self.topics = response;
        });
      })
      .error(function () {

      });

    this.create = function () {
      self.isSending = true;
      var newCard =
        {name: '['+self.ticket.topic.name+'] '+self.ticket.title,
        desc: self.ticket.text,
        pos: 'top',
        due: null,
        idList: self.backlog.id,
        idMembers: self.ticket.member
        };

        Trello.post('/cards/', newCard)
          .success(function (response) {
            $scope.$apply(function(){
              self.ticket.url = response.url;
            });

          })
          .error(function () {
            console.log('No se ha podido crear la tarjeta');
          });

    };
    this.reset = function () {
      self.ticket.topic = '';
      self.ticket.title = '';
      self.ticket.text = '';
      self.ticket.member = '';
      self.isSending = false;
    };
    this.changeBoard = function(){
      $location.path('/');
    };
  }

  angular.module('trellojs.controllers')
    .controller('TrelloLoginCtrl', TrelloLoginCtrl)
    .controller('NewCardCtrl', NewCardCtrl);
})();

(function(){
  'use strict';
  $('.selectpicker').selectpicker();
})();

(function(){
  'use strict';

  angular.module('trellojs.services', ['ngResource']);

  function Board() {
    var board = {};
    var topic = {};

    var backlog = {};

    var members = {}

    return {
        saveBoard:function (data) {
            board = data;
        },
        getBoard:function () {
            return board;
        },
        saveTopic:function (data) {
            topic = data;
        },
        getTopic:function () {
            return topic;
        },
        saveBacklog:function (data) {
            backlog = data;
        },
        getBacklog:function () {
            return backlog;
        },
        saveMembers:function (data) {
            members = data;
        },
        getMembers:function () {
            return members;
        }

    };
  }



  angular
    .module('trellojs.services')
    .factory('Board', Board);
})();

angular.module("trellojs.templates", []).run(["$templateCache", function($templateCache) {$templateCache.put("views/trello-login.tpl.html","<div class=\"row\">\n  <div class=\"col-md-12\">\n    <!-- Autenticación y selección de board -->\n    <div class=\"\" ng-show=\"!authenticated\">\n      <div class=\"jumbotron alert-warning\">\n\n        <p class=\"text-center\">\n          <button class=\"btn btn-success\" ng-click=\"authenticate()\" tabindex=\"0\">Authenticate</button>\n        </p>\n      </div>\n\n        <br/>\n        <div class=\"alert alert-info alert-dismissible fade in\" role=\"alert\">\n          <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">×</span></button>\n          <h4>Configure your Trello Board!</h4>\n          <p>If you want send tickets with this tools, your Trello Board should have two lists, at least:</p>\n          <p>\n            <ul>\n              <li><strong><em>Topic List</em></strong>: the cards on this lists represents the topics/sites/categories for tickets.</li>\n              <li><strong><em>Backlog list</em></strong>: this list stores all tasks as Trello cards.</li>\n            </ul>\n          </p>\n        </div>\n    </div>\n    <div class=\"\" ng-show=\"authenticated\">\n\n      <form name=\"setTrello\" class=\"form-horizontal\">\n        <fieldset class=\"form-group form-group-lg\">\n          <label class=\"col-sm-2 control-label\">Select board</label>\n          <div class=\"col-sm-10\">\n            <p class=\"text-center\" ng-hide=\"boardsLoaded\">\n              <i class=\"fa fa-spinner fa-spin\"></i>\n            </p>\n            <select class=\"selectpicker show-tick show-menu-arrow\"\n                    data-live-search=\"true\"\n                    ng-model=\"selectedBoard\"\n                    ng-options=\"board.name for board in boards track by board.id\"\n                    ng-change=\"selectBoard()\"\n                    >\n            </select>\n          </div>\n        </fieldset>\n        <fieldset class=\"form-group form-group-sm\" ng-show=\"selectedBoard\">\n          <label class=\"col-sm-2 control-label\">Select Topic list</label>\n          <div class=\"col-sm-10\">\n            <select class=\"form-control\"\n                    ng-model=\"trellologin.topic\"\n                    ng-options=\"list.name for list in allLists track by list.id\"\n                    ng-change=\"getTopics()\">\n            </select>\n          </div>\n        </fieldset>\n        <fieldset class=\"form-group form-group-sm\" ng-show=\"selectedBoard\">\n          <label class=\"col-sm-2 control-label\">Select Backlog list</label>\n          <div class=\"col-sm-10\">\n            <select class=\"form-control\"\n                    ng-model=\"trellologin.backlog\"\n                    ng-options=\"list.name for list in allLists track by list.id\">\n            </select>\n          </div>\n        </fieldset>\n        <a  href=\"/new\"\n            class=\"btn btn-primary btn-lg\"\n            type=\"submit\"\n            ng-disable=\"!setTrello.$valid\"\n            ng-click=\"save()\">\n          <span class=\"fa fa-rocket\"> Go</span>\n        </a>\n      </form>\n    </div>\n  </div>\n</div>\n\n\n<div class=\"row\">\n  <!-- tareas en proceso -->\n  <div class=\"col-md-4\" ng-repeat=\"dev in developments\">\n    <div class=\"panel panel-primary\">\n      <div class=\"panel-heading\">\n        <h3 class=\"panel-title\"><a href=\"{{ dev.url }}\">{{ dev.name }}</a></h3>\n      </div>\n      <div class=\"panel-body\">{{ dev.desc }}</div>\n    </div>\n  </div>\n</div>\n");
$templateCache.put("views/trello-new-card.tpl.html","<div class=\"row\">\n\n  <div class=\"col-md-12\" ng-hide=\"newcard.isSending\">\n    <h3>Write the user story <span class=\"label label-default\">New</span></h3>\n    <!-- panel principal -->\n\n      <div class=\"row\">\n        <!-- formulario -->\n        <section>\n          <form class=\"form-horizontal\" name=\"createTicket\" role=\"form\" ng-submit=\"newcard.create()\">\n            <!-- topic/site -->\n            <fieldset class=\"form-group form-group-lg\">\n              <label class=\"col-sm-2 control-label\">Topic</label>\n              <div class=\"col-sm-10\">\n                <select class=\"form-control\"\n                        ng-model=\"newcard.ticket.topic\"\n                        ng-options=\"topic.name for topic in newcard.topics track by topic.id\">\n                </select>\n              </div>\n            </fieldset>\n            <fieldset class=\"form-group form-group-lg\">\n              <label class=\"col-sm-2 control-label\">Title</label>\n              <div class=\"col-sm-10\">\n                <input class=\"form-control input-lg\"\n                        type=\"text\"\n                        placeholder=\"Task title\"\n                        ng-model=\"newcard.ticket.title\">\n              </div>\n            </fieldset>\n            <fieldset class=\"form-group form-group-lg\">\n              <label class=\"col-sm-2 control-label\">Description</label>\n              <div class=\"col-sm-10\">\n                <textarea class=\"form-control input-lg\"\n                          placeholder=\"Description\"\n                          ng-model=\"newcard.ticket.text\"></textarea>\n              </div>\n            </fieldset>\n\n            <!-- who are you? -->\n            <fieldset class=\"form-group form-group-lg\">\n              <label class=\"col-sm-2 control-label\">Who are you?</label>\n              <div class=\"col-sm-10\">\n                <div class=\"radio\" ng-repeat=\"member in newcard.members\">\n                  <label>\n                    <input type=\"radio\" ng-model=\"newcard.ticket.member\" value=\"{{ member.id }}\">\n                    {{ member.fullName }}\n                  </label>\n                </div>\n              </div>\n          </fieldset>\n\n\n            <!-- priority -->\n            <fieldset class=\"form-group form-group-sm\">\n              <label class=\"col-sm-2 control-label\">Ready?</label>\n              <div class=\"col-sm-10\">\n                <button class=\"btn btn-primary btn-lg\"\n                        type=\"submit\" ng-disable=\"!createTicket.$valid\">\n                  <span class=\"fa fa-rocket\"> Send</span>\n                </button>\n                <a ng-click=\"newcard.changeBoard()\" type=\"button\" class=\"btn btn-default\">Change board</a>\n              </div>\n          </fieldset>\n\n          </form>\n\n        </section>\n      </div>\n\n\n  </div>\n  <div class=\"col-md-12\" ng-show=\"newcard.isSending\">\n    <div class=\"alert alert-success alert-dismissible fade in\" role=\"alert\">\n      <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">×</span></button>\n      <h4>The ticket has been created correctly!</h4>\n      <p>Check more details on Trello.</p>\n      <p>\n        <a href=\"{{newcard.ticket.url}}\" type=\"button\" class=\"btn btn-danger\">See ticket in Trello</a>\n        <a ng-click=\"newcard.reset()\" type=\"button\" class=\"btn btn-info\">Send another one</a>\n        <a ng-click=\"newcard.changeBoard()\" type=\"button\" class=\"btn btn-default\">Change board</a>\n      </p>\n    </div>\n  </div>\n</div>\n");}]);